<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid Studio Offline</title>
    
    <!-- 1. TAILWIND CSS (Styling) -->
    <!-- For strict offline, download this file and change src to "./tailwindcss.js" -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. REACT & BABEL (Core Library) -->
    <!-- For strict offline, download these files and update the src paths -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom scrollbar hiding for clean UI */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Grid pattern for the preview area */
        .bg-pattern-grid {
            background-image: radial-gradient(currentColor 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- MAIN APPLICATION CODE -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- ICONS (Inline SVGs to remove external dependencies) ---
        const Icons = {
            Plus: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            X: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
            Download: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
            FileCode: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>,
            Image: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>,
            AlertCircle: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>,
            Check: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"></polyline></svg>,
            Sun: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>,
            Moon: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        };

        // --- UTILS ---
        function useDebounce(value, delay) {
            const [debouncedValue, setDebouncedValue] = useState(value);
            useEffect(() => {
                const handler = setTimeout(() => {
                    setDebouncedValue(value);
                }, delay);
                return () => clearTimeout(handler);
            }, [value, delay]);
            return debouncedValue;
        }

        const downloadFile = (content, filename, contentType) => {
            const a = document.createElement('a');
            const file = new Blob([content], { type: contentType });
            a.href = URL.createObjectURL(file);
            a.download = filename;
            a.click();
            URL.revokeObjectURL(a.href);
        };

        const DEFAULT_CODE = `graph TD
    A[Start] --> B{Is it working?}
    B -- Yes --> C[Great!]
    B -- No --> D[Debug]
    D --> B`;

        // --- MAIN APP COMPONENT ---
        function App() {
            const [tabs, setTabs] = useState([
                { id: 'tab-1', title: 'Diagram 1', code: DEFAULT_CODE }
            ]);
            const [activeTabId, setActiveTabId] = useState('tab-1');
            const [isMermaidLoaded, setIsMermaidLoaded] = useState(false);
            const [renderError, setRenderError] = useState(null);
            const [svgContent, setSvgContent] = useState('');
            const [isDark, setIsDark] = useState(true);
            const [loadSource, setLoadSource] = useState('Initializing...');

            const mermaidRef = useRef(null);
            
            const activeTab = tabs.find(t => t.id === activeTabId) || tabs[0];
            const debouncedCode = useDebounce(activeTab.code, 800);

            // --- MERMAID LOADING LOGIC ---
            useEffect(() => {
                // Check if mermaid is already loaded (e.g. from a <script> tag in head)
                if (window.mermaid) {
                    setIsMermaidLoaded(true);
                    setLoadSource('Loaded from existing window.mermaid');
                    window.mermaid.initialize({ 
                        startOnLoad: false, 
                        theme: isDark ? 'dark' : 'default',
                        securityLevel: 'loose'
                    });
                    return;
                }

                const loadMermaid = async () => {
                    setLoadSource('Trying local ./mermaid.min.js ...');
                    
                    // 1. Try Local File first
                    const localScript = document.createElement('script');
                    localScript.src = './mermaid.min.js';
                    
                    localScript.onload = () => {
                        console.log('Loaded local mermaid');
                        window.mermaid.initialize({ 
                            startOnLoad: false,
                            theme: isDark ? 'dark' : 'default',
                            securityLevel: 'loose'
                        });
                        setIsMermaidLoaded(true);
                        setLoadSource('Loaded locally');
                    };

                    localScript.onerror = () => {
                        console.log('Local load failed, trying CDN');
                        setLoadSource('Local failed. Trying CDN...');
                        
                        // 2. Fallback to CDN
                        const cdnScript = document.createElement('script');
                        cdnScript.src = 'https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js';
                        
                        cdnScript.onload = () => {
                            window.mermaid.initialize({ 
                                startOnLoad: false,
                                theme: isDark ? 'dark' : 'default',
                                securityLevel: 'loose'
                            });
                            setIsMermaidLoaded(true);
                            setLoadSource('Loaded from CDN');
                        };
                        
                        cdnScript.onerror = () => {
                            setRenderError("Failed to load mermaid.min.js. Please place it in the folder or connect to internet.");
                            setLoadSource('Load Failed');
                        };
                        document.head.appendChild(cdnScript);
                    };

                    document.head.appendChild(localScript);
                };

                loadMermaid();
            }, []);

            // Theme Effect
            useEffect(() => {
                if (isMermaidLoaded && window.mermaid) {
                    // Re-initialize isn't always enough to change theme dynamically in all versions, 
                    // but it helps reset defaults for next render.
                    window.mermaid.initialize({ theme: isDark ? 'dark' : 'default' });
                    renderDiagram(activeTab.code);
                }
            }, [isDark, isMermaidLoaded]);

            // Rendering
            const renderDiagram = useCallback(async (code) => {
                if (!window.mermaid || !mermaidRef.current) return;
                try {
                    if (!code.trim()) {
                        setSvgContent('');
                        setRenderError(null);
                        return;
                    }
                    const id = `mermaid-render-${Date.now()}`;
                    const { svg } = await window.mermaid.render(id, code);
                    setSvgContent(svg);
                    setRenderError(null);
                } catch (err) {
                    console.error("Mermaid Render Error:", err);
                    setRenderError(err.message || "Syntax Error");
                }
            }, []);

            useEffect(() => {
                if (isMermaidLoaded) {
                    renderDiagram(debouncedCode);
                }
            }, [debouncedCode, isMermaidLoaded, renderDiagram]);

            // Handlers
            const addTab = () => {
                const newId = `tab-${Date.now()}`;
                const newTab = {
                    id: newId,
                    title: `Diagram ${tabs.length + 1}`,
                    code: `graph TD\n    New${tabs.length + 1}[New Node] --> End`
                };
                setTabs([...tabs, newTab]);
                setActiveTabId(newId);
            };

            const closeTab = (e, id) => {
                e.stopPropagation();
                if (tabs.length === 1) return;
                const newTabs = tabs.filter(t => t.id !== id);
                setTabs(newTabs);
                if (activeTabId === id) setActiveTabId(newTabs[newTabs.length - 1].id);
            };

            const updateCode = (newCode) => {
                setTabs(tabs.map(t => t.id === activeTabId ? { ...t, code: newCode } : t));
            };

            const updateTitle = (newTitle) => {
                setTabs(tabs.map(t => t.id === activeTabId ? { ...t, title: newTitle } : t));
            };

            const saveCode = () => {
                downloadFile(activeTab.code, `${activeTab.title}.mmd`, 'text/plain');
            };

            const saveSvg = () => {
                if (!svgContent) return;
                downloadFile(svgContent, `${activeTab.title}.svg`, 'image/svg+xml');
            };

            const savePng = () => {
                if (!svgContent) return;
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                // We need to encode the SVG properly for it to load as an image source
                const svgBlob = new Blob([svgContent], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);
                
                img.onload = () => {
                    canvas.width = img.width * 2;
                    canvas.height = img.height * 2;
                    ctx.fillStyle = isDark ? '#1e1e1e' : '#ffffff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob((blob) => {
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = `${activeTab.title}.png`;
                        a.click();
                        URL.revokeObjectURL(url);
                        URL.revokeObjectURL(a.href);
                    });
                };
                img.src = url;
            };

            // Styles
            const themeClasses = isDark ? "bg-gray-900 text-gray-100" : "bg-gray-50 text-gray-900";
            const borderClasses = isDark ? "border-gray-700" : "border-gray-300";

            return (
                <div className={`flex flex-col h-screen w-full overflow-hidden font-sans ${themeClasses}`}>
                    
                    {/* Header */}
                    <header className={`flex items-center justify-between px-4 py-2 border-b ${isDark ? 'border-gray-700 bg-gray-900' : 'border-gray-300 bg-white'}`}>
                        <div className="flex items-center space-x-2">
                            <div className="p-1 rounded bg-blue-600 text-white">
                                <Icons.FileCode className="w-5 h-5" />
                            </div>
                            <h1 className="text-lg font-bold tracking-tight hidden sm:block">Mermaid Studio</h1>
                            <span className="text-xs text-gray-500 ml-2 border px-1 rounded border-gray-600">
                                {isMermaidLoaded ? "Ready" : loadSource}
                            </span>
                        </div>

                        {/* Tabs */}
                        <div className="flex-1 mx-4 overflow-x-auto no-scrollbar">
                            <div className="flex space-x-1">
                                {tabs.map(tab => (
                                    <div 
                                        key={tab.id}
                                        onClick={() => setActiveTabId(tab.id)}
                                        className={`
                                            group flex items-center min-w-[120px] max-w-[200px] px-3 py-1.5 rounded-t-lg cursor-pointer text-sm select-none border-t border-l border-r
                                            ${activeTabId === tab.id 
                                                ? (isDark ? 'bg-gray-800 border-gray-700 text-blue-400' : 'bg-white border-gray-300 text-blue-600') 
                                                : (isDark ? 'bg-gray-900 border-transparent text-gray-500 hover:bg-gray-800' : 'bg-gray-100 border-transparent text-gray-500 hover:bg-white')}
                                        `}
                                    >
                                        <span className="truncate flex-1">{tab.title}</span>
                                        <button 
                                            onClick={(e) => closeTab(e, tab.id)}
                                            className={`opacity-0 group-hover:opacity-100 ml-2 p-0.5 rounded-full hover:bg-red-500 hover:text-white transition-all ${tabs.length === 1 ? 'hidden' : ''}`}
                                        >
                                            <Icons.X className="w-3 h-3" />
                                        </button>
                                    </div>
                                ))}
                                <button onClick={addTab} className={`p-1.5 rounded-lg hover:bg-opacity-20 ${isDark ? 'hover:bg-gray-500 text-gray-400' : 'hover:bg-gray-300 text-gray-600'}`}>
                                    <Icons.Plus className="w-5 h-5" />
                                </button>
                            </div>
                        </div>

                        {/* Theme Toggle */}
                        <button onClick={() => setIsDark(!isDark)} className="p-2 rounded-lg hover:bg-opacity-20 hover:bg-gray-500">
                            {isDark ? <Icons.Sun className="w-4 h-4" /> : <Icons.Moon className="w-4 h-4" />}
                        </button>
                    </header>

                    {/* Main */}
                    <main className="flex-1 flex overflow-hidden">
                        
                        {/* Editor */}
                        <section className={`flex flex-col w-1/2 md:w-5/12 border-r ${borderClasses} relative transition-all`}>
                            <div className={`flex items-center justify-between px-3 py-2 border-b text-xs font-mono uppercase ${isDark ? 'bg-gray-800 border-gray-700 text-gray-400' : 'bg-gray-50 border-gray-200 text-gray-500'}`}>
                                <span>Code Editor</span>
                                <button onClick={saveCode} className="hover:text-blue-500 flex items-center">
                                    <Icons.Download className="w-3 h-3 mr-1" /> MMD
                                </button>
                            </div>
                            <div className="relative flex-1">
                                <textarea
                                    value={activeTab.code}
                                    onChange={(e) => updateCode(e.target.value)}
                                    className={`w-full h-full p-4 font-mono text-sm resize-none focus:outline-none ${isDark ? 'bg-gray-900 text-gray-300' : 'bg-white text-gray-800'}`}
                                    spellCheck="false"
                                />
                            </div>
                            <div className={`p-3 border-t ${isDark ? 'border-gray-700 bg-gray-800' : 'border-gray-200 bg-gray-50'}`}>
                                <label className="text-xs font-medium uppercase text-gray-500 mb-1 block">Title</label>
                                <input 
                                    type="text" 
                                    value={activeTab.title}
                                    onChange={(e) => updateTitle(e.target.value)}
                                    className={`w-full px-2 py-1 text-sm rounded border focus:outline-none ${isDark ? 'bg-gray-900 border-gray-600' : 'bg-white border-gray-300'}`}
                                />
                            </div>
                        </section>

                        {/* Preview */}
                        <section className={`flex flex-col flex-1 relative ${isDark ? 'bg-gray-900' : 'bg-gray-100'}`}>
                            <div className={`flex items-center justify-between px-3 py-2 border-b text-xs font-mono uppercase z-10 ${isDark ? 'bg-gray-800 border-gray-700 text-gray-400' : 'bg-white border-gray-200 text-gray-500 shadow-sm'}`}>
                                <span className="flex items-center">
                                    Preview
                                    {renderError && <span className="ml-2 text-red-500 flex items-center normal-case"><Icons.AlertCircle className="w-3 h-3 mr-1"/> Error</span>}
                                    {!renderError && svgContent && <span className="ml-2 text-green-500 flex items-center normal-case"><Icons.Check className="w-3 h-3 mr-1"/> OK</span>}
                                </span>
                                <div className="flex space-x-3">
                                    <button onClick={saveSvg} disabled={!svgContent} className="flex items-center hover:text-blue-500 disabled:opacity-50"><Icons.Image className="w-3 h-3 mr-1" /> SVG</button>
                                    <button onClick={savePng} disabled={!svgContent} className="flex items-center hover:text-blue-500 disabled:opacity-50"><Icons.Image className="w-3 h-3 mr-1" /> PNG</button>
                                </div>
                            </div>
                            <div className="flex-1 overflow-auto p-8 flex items-center justify-center relative bg-pattern-grid">
                                <div className={`absolute inset-0 opacity-5 pointer-events-none ${isDark ? 'bg-white' : 'bg-black'}`}></div>
                                <div 
                                    ref={mermaidRef}
                                    className={`transition-all duration-300 ${renderError ? 'opacity-50 blur-sm' : 'opacity-100'}`}
                                    dangerouslySetInnerHTML={{ __html: svgContent }}
                                />
                                {renderError && (
                                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                        <div className="bg-red-500 text-white px-4 py-3 rounded shadow-lg max-w-md text-center text-sm font-medium z-20">
                                            <p>{renderError}</p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </section>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>